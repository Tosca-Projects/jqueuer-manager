tosca_definitions_version: tosca_simple_yaml_1_0

imports:
  - https://raw.githubusercontent.com/micado-scale/tosca/v0.7.3/micado_types.yaml

repositories:
  docker_hub: https://hub.docker.com/

topology_template:
  node_templates:
    jqueuer-rabbit:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
        env:
          - name: RABBITMQ_DEFAULT_USER
            value: admin
          - name: RABBITMQ_DEFAULT_PASS
            value: mypass
        ports:
        - target: 5672
      requirements:
      - host:
          node: jq-server
      artifacts:
        image:
          type: tosca.artifacts.Deployment.Image.Container.Docker
          file: rabbitmq:3.7
          repository: docker_hub
      interfaces:
        Kubernetes:
          create:
            implementation: image
          configure:
            inputs:
              restartPolicy: "Always"

    jqueuer-redis:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
        command:
        - redis-server
        args:
        - --requirepass mypass
        ports:
        - target: 6379
      requirements:
      - host:
          node: jq-server
      artifacts:
        image:
          type: tosca.artifacts.Deployment.Image.Container.Docker
          file: redis:alpine3.10
          repository: docker_hub
      interfaces:
        Kubernetes:
          create:
            implementation: image
          configure:
            inputs:
              restartPolicy: "Always"

    jqueuer-manager:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
        ports:
        - containerPort: 9081
        - target: 8081
          nodePort: 30888
      requirements:
      - host:
          node: jq-server
      artifacts:
        image:
          type: tosca.artifacts.Deployment.Image.Container.Docker
          file: jaydes/jqueuer-manager:dev 
          repository: docker_hub
      interfaces:
        Kubernetes:
          create:
            implementation: image
          configure:
            inputs:
              restartPolicy: "Always"

    jqueuer-statsd:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
        env:
          - name: RABBIT_URL
            value: http://rabbitmq:15672
          - name: PUBLISH_PORT
            value: "8090"
          - name: RABBIT_EXPORTERS
            value: queue
        ports:
        - containerPort: 9102
        - target: 9125
          protocol: UDP
      requirements:
      - host:
          node: jq-server
      artifacts:
        image:
          type: tosca.artifacts.Deployment.Image.Container.Docker
          file: prom/statsd-exporter:v0.11.2
          repository: docker_hub
      interfaces:
        Kubernetes:
          create:
            implementation: image
          configure:
            inputs:
              restartPolicy: "Always"

    jqueuer-agent:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      artifacts:
        image:
          type: tosca.artifacts.Deployment.Image.Container.Docker
          file: jaydes/jqueuer-agent:dev 
          repository: docker_hub
      requirements:
        - host:
            node: worker-node
        - volume:
            node: docker-binary-host-vol
            relationship:
              type: tosca.relationships.AttachesTo
              properties:
                location: /usr/bin/docker
        - volume:
            node: docker-socket-host-vol
            relationship:
              type: tosca.relationships.AttachesTo
              properties:
                location: /var/run/docker.sock
      interfaces:
        Kubernetes:
          create:
            implementation: image
            inputs:
              kind: DaemonSet
          configure:
            inputs:
              restartPolicy: "Always"

    docker-binary-host-vol:
      type: tosca.nodes.MiCADO.Container.Volume
      properties:
        name: docker-bin
      interfaces:
        Kubernetes:
          create:
            inputs:
              hostPath:
                path: /usr/bin/docker

    docker-socket-host-vol:
      type: tosca.nodes.MiCADO.Container.Volume
      properties:
        name: docker-socket
      interfaces:
        Kubernetes:
          create:
            inputs:
              hostPath:
                path: /var/run/docker.sock
###
### The container image below might need to be changed depending on your experimentation tool
###
    worker:
      type: tosca.nodes.MiCADO.Container.Application.Docker
      properties:
        tty: true
      artifacts:
        image:
          type: tosca.artifacts.Deployment.Image.Container.Docker
          file: osabuoun/repast
          repository: docker_hub
      requirements:
        - host:
            node: worker-node
      interfaces:
        Kubernetes:
          create:
            implementation: image
          configure:
            inputs:
              restartPolicy: "Always"
###
### The worker node is directly below, change resources if necessary
###
    worker-node:
      type: tosca.nodes.MiCADO.CloudSigma.Compute
      properties:
        num_cpus: 2000
        mem_size: 2147483648
        vnc_password: secret
        libdrive_id: ADD_YOUR_LIBRARY_DRIVE_ID_HERE
        public_key_id: ADD_YOUR_PUBLIC_KEY_ID_HERE
        nics:
        - firewall_policy: ADD_YOUR_FIREWALL_POLICY_ID_HERE
          ip_v4_conf:
            conf: dhcp
      interfaces:
        Occopus:
          create:
            inputs:
              interface_cloud: cloudsigma
              endpoint_cloud: ADD_YOUR_ENDPOINT
      capabilities:
        host:
          properties:
            num_cpus: 2
            mem_size: 2 GB

    jq-server:
      type: tosca.nodes.MiCADO.CloudSigma.Compute
      properties:
        num_cpus: 2000
        mem_size: 2147483648
        vnc_password: secret
        libdrive_id: ADD_YOUR_LIBRARY_DRIVE_ID_HERE
        public_key_id: ADD_YOUR_PUBLIC_KEY_ID_HERE
        nics:
        - firewall_policy: ADD_YOUR_FIREWALL_POLICY_ID_HERE
          ip_v4_conf:
            conf: dhcp        
        context:
          append: true
          cloud_config: |
            runcmd:
            - echo never > /sys/kernel/mm/transparent_hugepage/enabled
      interfaces:
        Occopus:
          create:
            inputs:
              interface_cloud: cloudsigma
              endpoint_cloud: ADD_YOUR_ENDPOINT
      capabilities:
        host:
          properties:
            num_cpus: 2
            mem_size: 2 GB
###
### The policies are below
###
  policies:
    - scalability:
        type: tosca.policies.Scaling.MiCADO
        targets: [ worker-node ]
        properties:
          sources:
          - 'jqueuer-statsd:9102'
          - 'jqueuer-manager:9081'
          constants:
            MAXNODES: 4 
            MAXCONTAINERS: 4
            EXPERIMENT_ID: exp_123456789_123
          queries:
            AET: "jqueuer_single_task_duration{experiment_id='{{EXPERIMENT_ID}}'}"
            REMAININGTIME: "jqueuer_experiment_deadline{experiment_id='{{EXPERIMENT_ID}}'}-time()"
            FIRSTJOB: "min(jqueuer_job_running_timestamp{experiment_id='{{EXPERIMENT_ID}}'})"
            JOBSRUN: "count(jqueuer_job_running{experiment_id='{{EXPERIMENT_ID}}'} == 1)"
            JOBSFAIL: "count(jqueuer_job_failed{experiment_id='{{EXPERIMENT_ID}}'})"
            TOTALJOBS: "count(jqueuer_job_added{experiment_id='{{EXPERIMENT_ID}}'})"
            ITEMS: "count(jqueuer_job_added{experiment_id='{{EXPERIMENT_ID}}'})-count(jqueuer_task_accomplished{experiment_id='{{EXPERIMENT_ID}}'} == 1)"
            COMPLETED: "count(jqueuer_task_accomplished{experiment_id='{{EXPERIMENT_ID}}'} == 1)"
            CALC_AET: "AVG(jqueuer_task_accomplished_duration{experiment_id='{{EXPERIMENT_ID}}'})"
          min_instances: 0
          max_instances: "{{MAXNODES}}"
          scaling_rule: |
            reqnodes=0
            if COMPLETED and not ITEMS:
              ITEMS = TOTALJOBS - COMPLETED
            if COMPLETED>4:
              AET = CALC_AET
            if not COMPLETED:
              ITEMS = TOTALJOBS
            if ITEMS>0:              
              calculation = ceil(AET/((REMAININGTIME-AET*0.20)/ITEMS))
              if calculation <= 0:
                calculation = ITEMS
              reqconts = min([MAXCONTAINERS, calculation])
              reqnodes = ceil(reqconts)
              if reqnodes>m_node_count and JOBSRUN<ITEMS:
                m_node_count = min([reqnodes, MAXNODES])
              if REMAININGTIME>AET:
                if reqnodes<m_node_count-1 and m_time_since_node_count_changed>60:
                  m_node_count = max([0, reqnodes])
            else:
              m_node_count = 0
            print "Number of required nodes:",reqnodes
            print "Number of requested nodes:",m_node_count

    - scalability:
        type: tosca.policies.Scaling.MiCADO
        targets: [ worker ]
        properties:
          min_instances: 0
          max_instances: "{{MAXCONTAINERS}}"
          scaling_rule: |
            if COMPLETED and not ITEMS:
              ITEMS = TOTALJOBS - COMPLETED
            if COMPLETED>4:
              AET = CALC_AET
            if not COMPLETED:
              ITEMS = TOTALJOBS
            print "AET:",AET
            print "Remaining time:", REMAININGTIME
            print "Length of queue:", ITEMS
            print "Failed jobs:", JOBSFAIL
            required_count = 0
            if ITEMS>0:
              calculation = ceil(AET/((REMAININGTIME-AET*0.20)/ITEMS))
              if calculation <= 0:
                calculation = ITEMS
              required_count = min([MAXCONTAINERS, calculation])
              if REMAININGTIME>AET:
                if required_count<m_container_count-1:
                  m_container_count = min([required_count, len(m_nodes) * 1])
              if required_count>m_container_count and JOBSRUN<ITEMS:
                m_container_count = min([required_count, len(m_nodes) * 1])
            else:
              m_container_count = 0
            print "Number of required containers:",required_count
            print "Number of requested containers:",m_container_count